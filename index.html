<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CJM Builder Â· CX team</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
  background: #f5f5fb;
  color: #1a1a1a;
  min-height: 100vh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¹„ë°€ë²ˆí˜¸ í™”ë©´
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pw-screen {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(135deg, #1e1b4b 0%, #27236a 60%, #312e81 100%);
  display: flex; align-items: center; justify-content: center;
}
.pw-card {
  background: rgba(255,255,255,.07);
  backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 24px;
  padding: 52px 44px;
  text-align: center;
  width: 400px;
  box-shadow: 0 24px 64px rgba(0,0,0,.5);
}
.pw-logo { font-size: 22px; font-weight: 900; color: #a5b4fc; letter-spacing: -0.5px; margin-bottom: 4px; }
.pw-title { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 6px; }
.pw-sub { font-size: 13px; color: rgba(255,255,255,.45); margin-bottom: 36px; line-height: 1.6; }
.pw-input {
  width: 100%;
  background: rgba(255,255,255,.09);
  border: 1.5px solid rgba(255,255,255,.18);
  border-radius: 12px;
  padding: 14px 18px;
  font-size: 16px; color: #fff;
  outline: none; margin-bottom: 12px;
  letter-spacing: 3px;
  font-family: inherit;
  transition: border-color .2s;
}
.pw-input::placeholder { letter-spacing: 0; color: rgba(255,255,255,.35); }
.pw-input:focus { border-color: #818cf8; }
.pw-btn {
  width: 100%;
  background: #667eea; color: #fff;
  border: none; border-radius: 12px;
  padding: 14px; font-size: 15px; font-weight: 800;
  cursor: pointer; transition: opacity .15s;
  font-family: inherit;
}
.pw-btn:hover { opacity: .85; }
.pw-btn:disabled { opacity: .5; cursor: not-allowed; }
.pw-error { color: #a5b4fc; font-size: 13px; margin-top: 14px; min-height: 20px; }
.pw-shield { font-size: 36px; margin-bottom: 16px; display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë©”ì¸ ì•± (ìˆ¨ê¹€ â†’ ì¸ì¦ í›„ í‘œì‹œ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mainApp { display: none; }

/* â”€â”€â”€ ìƒë‹¨ ë°” â”€â”€ */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: #fff;
  border-bottom: 1px solid #e8e8f0;
  padding: 0 24px;
  height: 52px;
  display: flex; align-items: center; gap: 12px;
  box-shadow: 0 1px 6px rgba(102,126,234,.1);
}
.topbar-logo { font-size: 15px; font-weight: 900; color: #667eea; letter-spacing: -0.5px; }
.topbar-sep { color: #ddd; font-size: 18px; }
.topbar-title { font-size: 14px; font-weight: 700; color: #444; }
.topbar-tag {
  background: #eef0fe; color: #667eea;
  font-size: 10px; font-weight: 800;
  padding: 3px 10px; border-radius: 99px;
  border: 1px solid #c7cbff;
}
.topbar-spacer { flex: 1; }
.topbar-secure {
  font-size: 11px; color: #2e7d32;
  background: #e8f5e9; border: 1px solid #a5d6a7;
  border-radius: 99px; padding: 3px 10px;
  display: flex; align-items: center; gap: 4px;
}
.logout-btn {
  background: none; border: 1px solid #e0e0e0;
  border-radius: 8px; padding: 5px 12px;
  cursor: pointer; font-size: 12px; color: #888;
  font-family: inherit;
  transition: all .15s;
}
.logout-btn:hover { background: #f5f5f5; color: #333; }

/* â”€â”€â”€ íˆì–´ë¡œ â”€â”€ */
.hero {
  background: linear-gradient(135deg, #1e1b4b 0%, #27236a 60%, #312e81 100%);
  padding: 48px 24px 40px;
  text-align: center;
}
.hero-badge {
  display: inline-block;
  background: rgba(102,126,234,.2); color: #a5b4fc;
  font-size: 11px; font-weight: 700; letter-spacing: 2px;
  padding: 4px 14px; border-radius: 99px;
  border: 1px solid rgba(102,126,234,.4);
  margin-bottom: 16px;
}
.hero-title {
  font-size: 32px; font-weight: 900; color: #fff;
  letter-spacing: -1px; line-height: 1.2; margin-bottom: 8px;
}
.hero-title span { color: #a5b4fc; }
.hero-sub { font-size: 14px; color: rgba(255,255,255,.55); margin-bottom: 32px; }

.search-box {
  max-width: 680px; margin: 0 auto;
  display: flex; gap: 10px;
}
.search-input {
  flex: 1;
  background: rgba(255,255,255,.1);
  border: 1.5px solid rgba(255,255,255,.2);
  border-radius: 12px;
  padding: 14px 20px;
  font-size: 16px; color: #fff;
  outline: none; font-family: inherit;
  transition: border-color .2s;
}
.search-input::placeholder { color: rgba(255,255,255,.4); }
.search-input:focus { border-color: #818cf8; background: rgba(255,255,255,.15); }
.search-btn {
  background: #667eea; color: #fff;
  border: none; border-radius: 12px;
  padding: 14px 28px; font-size: 15px; font-weight: 800;
  cursor: pointer; white-space: nowrap; font-family: inherit;
  transition: all .15s;
}
.search-btn:hover { background: #5a6fd6; transform: translateY(-1px); }
.search-btn:active { transform: translateY(0); }
.search-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

.examples {
  max-width: 680px; margin: 16px auto 0;
  display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
}
.example-chip {
  background: rgba(255,255,255,.09);
  border: 1px solid rgba(255,255,255,.18);
  border-radius: 99px;
  padding: 5px 14px; font-size: 12px; color: rgba(255,255,255,.65);
  cursor: pointer; transition: all .15s;
}
.example-chip:hover { background: rgba(102,126,234,.3); border-color: #818cf8; color: #fff; }

/* â”€â”€â”€ ë¡œë”© â”€â”€ */
.loading-section { display: none; text-align: center; padding: 72px 24px; }
.loading-section.active { display: block; }
.spinner {
  width: 52px; height: 52px;
  border: 4px solid #eee; border-top-color: #667eea;
  border-radius: 50%;
  animation: spin .8s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 8px; }
.loading-sub { font-size: 13px; color: #aaa; }

/* â”€â”€â”€ ì—ëŸ¬ â”€â”€ */
.error-box {
  display: none;
  max-width: 680px; margin: 32px auto;
  background: #fff5f5; border: 1.5px solid #ffc2cc;
  border-radius: 12px; padding: 20px 24px;
  color: #c62828; font-size: 13px; line-height: 1.7;
  white-space: pre-wrap;
}
.error-box.active { display: block; }
.error-title { font-weight: 800; margin-bottom: 6px; font-size: 14px; }

/* â”€â”€â”€ ê²°ê³¼ â”€â”€ */
.results-section { padding: 24px; }
.legend {
  display: flex; gap: 16px; align-items: center;
  padding: 10px 0; margin-bottom: 20px; flex-wrap: wrap;
}
.legend-label { font-size: 12px; font-weight: 700; color: #555; margin-right: 4px; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #555; }
.legend-dot { width: 12px; height: 12px; border-radius: 3px; }
.dot-data   { background: #fff9c4; border: 1.5px solid #f9a825; }
.dot-search { background: #e8f5e9; border: 1.5px solid #43a047; }

/* â”€â”€â”€ CJM ì¹´ë“œ â”€â”€ */
.cjm-card { margin-bottom: 44px; }

.query-section {
  background: #fff; border-radius: 16px;
  padding: 18px 22px; margin-bottom: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
  border-left: 5px solid #667eea;
  display: flex; align-items: flex-start; gap: 16px; flex-wrap: wrap;
}
.query-label { font-size: 10px; font-weight: 800; color: #667eea; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
.query-chips { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.query-chip {
  display: inline-block;
  background: #eef0fe; color: #667eea;
  border: 1.5px solid #c7cbff;
  border-radius: 99px; padding: 4px 14px;
  font-size: 13px; font-weight: 700;
}
.query-arrow { color: #ccc; font-size: 16px; }
.query-meta { margin-left: auto; font-size: 11px; color: #999; text-align: right; }
.channel-badge {
  display: inline-block;
  background: #312e81; color: #fff;
  font-size: 10px; font-weight: 700;
  padding: 3px 10px; border-radius: 99px;
}

/* â”€â”€â”€ CJM í…Œì´ë¸” â”€â”€ */
.cjm-wrapper {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,.08);
  overflow: hidden;
}
.cjm-scroll { overflow-x: auto; }

.cjm-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 1200px;
}

.col-header {
  background: #312e81; color: #fff;
  text-align: center;
  padding: 14px 10px;
  font-size: 12px; font-weight: 700;
  border-right: 1px solid #3d3a9a;
  vertical-align: middle;
}
.col-header.first {
  background: #1e1b4b; font-size: 11px;
  border-right: 2px solid #3d3a9a;
  width: 110px; min-width: 110px;
  position: sticky; left: 0; z-index: 20;
}
.step-num {
  display: inline-block;
  background: #667eea; color: #fff;
  font-size: 10px; font-weight: 800;
  border-radius: 50%;
  width: 20px; height: 20px; line-height: 20px;
  text-align: center; margin-bottom: 4px;
}
.step-name { display: block; font-size: 11px; margin-top: 2px; line-height: 1.3; }

/* Phase í–‰ */
.phase-row td { border-bottom: 2px solid #e8e8e8; }
.phase-cell {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff; font-size: 10px; font-weight: 700;
  padding: 6px 10px; text-align: center;
  border-right: 1px solid rgba(255,255,255,.2);
}
.phase-first {
  background: #1e1b4b; color: rgba(255,255,255,.45);
  font-size: 9px; font-weight: 600;
  position: sticky; left: 0; z-index: 10;
  padding: 6px 10px; text-align: center;
  border-right: 2px solid #3d3a9a;
}

/* í–‰ í—¤ë” */
.row-header {
  width: 110px; min-width: 110px;
  padding: 12px 10px;
  text-align: center;
  font-size: 11px; font-weight: 800;
  vertical-align: middle;
  border-right: 2px solid #e8e8e8;
  border-bottom: 1px solid #f0f0f0;
  position: sticky; left: 0; z-index: 10;
  line-height: 1.4;
}
.rh-action  { background: #e8eeff; color: #3949ab; }
.rh-feeling { background: #fff8e1; color: #e65100; }
.rh-pain    { background: #fce4ec; color: #c62828; }
.rh-needs   { background: #f3e5f5; color: #6a1b9a; }
.rh-insight { background: #e8f5e9; color: #2e7d32; }

/* ë°ì´í„° ì…€ */
td.cell {
  padding: 10px;
  vertical-align: top;
  border-right: 1px solid #f0f0f0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 11px; line-height: 1.6;
  min-width: 160px;
}

/* ë…¸íŠ¸ */
.note {
  display: block; border-radius: 8px;
  padding: 8px 10px; margin-bottom: 6px;
  font-size: 11px; line-height: 1.5;
}
.note:last-child { margin-bottom: 0; }
.note-data {
  background: #fffde7;
  border: 1.5px solid #f9a825;
  box-shadow: 2px 2px 0 rgba(249,168,37,.15);
}
.note-search {
  background: #f1f8e9;
  border: 1.5px solid #7cb342;
  box-shadow: 2px 2px 0 rgba(124,179,66,.1);
}
.note-icon {
  font-size: 9px; font-weight: 800;
  border-radius: 3px; padding: 1px 5px;
  display: inline-block; margin-bottom: 4px;
}
.icon-data   { background: #f9a825; color: #fff; }
.icon-search { background: #7cb342; color: #fff; }

/* â”€â”€â”€ ì¶œì²˜ íˆ´íŒ â”€â”€ */
.src-tip {
  position: relative;
  display: inline-block;
  cursor: help;
  font-size: 9px; font-style: normal;
  color: #667eea;
  background: #eef0fe;
  border: 1px solid #c7cbff;
  border-radius: 4px;
  padding: 2px 6px;
  margin-top: 5px;
  user-select: none;
}
.src-tip::before {
  content: '';
  position: absolute;
  bottom: calc(100% + 2px);
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: #1e1b4b;
  pointer-events: none;
  visibility: hidden;
  opacity: 0;
  transition: opacity .15s;
  z-index: 9998;
}
.src-tip::after {
  content: attr(data-tip);
  position: absolute;
  bottom: calc(100% + 12px);
  left: 50%;
  transform: translateX(-50%);
  background: #1e1b4b;
  color: #e0e7ff;
  font-size: 11px;
  line-height: 1.6;
  padding: 8px 12px;
  border-radius: 8px;
  white-space: normal;
  word-break: keep-all;
  min-width: 200px;
  max-width: 300px;
  z-index: 9999;
  box-shadow: 0 4px 16px rgba(0,0,0,.3);
  pointer-events: none;
  visibility: hidden;
  opacity: 0;
  transition: opacity .15s;
  text-align: left;
}
.src-tip:hover::before,
.src-tip:hover::after {
  visibility: visible;
  opacity: 1;
}

.quote-text {
  font-style: italic; color: #555;
  padding: 4px 8px;
  border-left: 3px solid #ffb300;
  background: #fffde7;
  border-radius: 0 6px 6px 0;
  line-height: 1.5;
}

/* â”€â”€â”€ ë¹ˆ ìƒíƒœ â”€â”€ */
.empty-state {
  text-align: center; padding: 80px 24px;
  color: #ccc;
}
.empty-icon { font-size: 52px; margin-bottom: 16px; }
.empty-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.empty-sub { font-size: 13px; }

/* â”€â”€â”€ í‘¸í„° â”€â”€ */
.footer {
  text-align: center; padding: 20px 24px;
  font-size: 11px; color: #c8c8d8;
  border-top: 1px solid #eef0fe; margin-top: 8px;
}

@media print {
  .topbar, .hero, .pw-screen { display: none !important; }
  body { background: #fff; }
  .cjm-wrapper { box-shadow: none; border: 1px solid #ddd; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë¹„ë°€ë²ˆí˜¸ í™”ë©´
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="pw-screen" id="pwScreen">
  <div class="pw-card">
    <span class="pw-shield">ğŸ”</span>
    <div class="pw-logo">CX team</div>
    <div class="pw-title">CJM Builder</div>
    <div class="pw-sub">ë‚´ë¶€ ì „ìš© ì‹œìŠ¤í…œì…ë‹ˆë‹¤.<br>ì ‘ì† ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
    <input type="password" class="pw-input" id="pwInput"
           placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
           onkeydown="if(event.key==='Enter') doLogin()">
    <button class="pw-btn" id="pwBtn" onclick="doLogin()">ì…ì¥í•˜ê¸°</button>
    <div class="pw-error" id="pwError"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë©”ì¸ ì•±
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp">

<!-- ìƒë‹¨ ë°” -->
<div class="topbar">
  <span class="topbar-logo">CX team</span>
  <span class="topbar-sep">|</span>
  <span class="topbar-title">CJM Builder</span>
  <span class="topbar-tag">AI POWERED</span>
  <span class="topbar-spacer"></span>
  <span class="topbar-secure">ğŸ”’ ë³´ì•ˆ ì—°ê²°</span>
  <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<!-- íˆì–´ë¡œ -->
<div class="hero">
  <div class="hero-badge">MULTI-AGENT Â· GPT-4o POWERED</div>
  <h1 class="hero-title">Customer Journey Map<br><span>ìë™í™” ìƒì„±ê¸°</span></h1>
  <p class="hero-sub">í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ì¸í„°ë·° ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ CJMì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤</p>

  <div class="search-box">
    <input type="text" class="search-input" id="keywordInput"
           placeholder="ì˜ˆ: ë²ˆí˜¸ ì´ë™, ìš”ê¸ˆì œ ë³€ê²½, ì—¬í–‰, ë©¤ë²„ì‹­ í˜œíƒ..."
           onkeydown="if(event.key==='Enter') generate()">
    <button class="search-btn" id="generateBtn" onclick="generate()">
      CJM ìƒì„± â†’
    </button>
  </div>

  <div class="examples">
    <span class="example-chip" onclick="setEx('ë²ˆí˜¸ ì´ë™')">ë²ˆí˜¸ ì´ë™</span>
    <span class="example-chip" onclick="setEx('ìš”ê¸ˆì œ ë³€ê²½')">ìš”ê¸ˆì œ ë³€ê²½</span>
    <span class="example-chip" onclick="setEx('í•´ì™¸ ì—¬í–‰')">í•´ì™¸ ì—¬í–‰</span>
    <span class="example-chip" onclick="setEx('ë©¤ë²„ì‹­ í˜œíƒ')">ë©¤ë²„ì‹­ í˜œíƒ</span>
    <span class="example-chip" onclick="setEx('ë‹¨ë§ê¸° êµ¬ë§¤')">ë‹¨ë§ê¸° êµ¬ë§¤</span>
    <span class="example-chip" onclick="setEx('ë¯¸ë‚© ìš”ê¸ˆ')">ë¯¸ë‚© ìš”ê¸ˆ</span>
    <span class="example-chip" onclick="setEx('ì‹ ê·œ ê°€ì…')">ì‹ ê·œ ê°€ì…</span>
    <span class="example-chip" onclick="setEx('Tìš°ì£¼ êµ¬ë…')">Tìš°ì£¼ êµ¬ë…</span>
  </div>
</div>

<!-- ë¡œë”© -->
<div class="loading-section" id="loadingSection">
  <div class="spinner"></div>
  <div class="loading-text">CJM ìƒì„± ì¤‘...</div>
  <div class="loading-sub">ì—ì´ì „íŠ¸ 1â†’2â†’3â†’4 ìˆœì°¨ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (30~60ì´ˆ)</div>
</div>

<!-- ì—ëŸ¬ -->
<div class="error-box" id="errorBox">
  <div class="error-title">âš  ì˜¤ë¥˜</div>
  <div id="errorMsg"></div>
</div>

<!-- ê²°ê³¼ -->
<div class="results-section" id="resultsSection" style="display:none">
  <div class="legend">
    <span class="legend-label">ë²”ë¡€</span>
    <span class="legend-item">
      <span class="legend-dot dot-data"></span>
      ğŸ“‹ ë°ì´í„° ê¸°ë°˜ (ì—ì´ì „íŠ¸3 Â· ì¸í„°ë·°/CSI, í•˜ì´ë¼ì´íŠ¸)
    </span>
    <span class="legend-item">
      <span class="legend-dot dot-search"></span>
      ğŸ” ì¼ë°˜ì§€ì‹ ê¸°ë°˜ (ì—ì´ì „íŠ¸4 Â· UX ê´€ì )
    </span>
  </div>
  <div id="cjmContainer"></div>
</div>

<!-- ë¹ˆ ìƒíƒœ -->
<div class="empty-state" id="emptyState">
  <div class="empty-icon">ğŸ—º</div>
  <div class="empty-title">CJMì„ ìƒì„±í•´ë³´ì„¸ìš”</div>
  <div class="empty-sub">ìœ„ ê²€ìƒ‰ì°½ì— í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ Customer Journey Mapì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</div>
</div>

<!-- í‘¸í„° -->
<div class="footer">CX team CJM Builder</div>

</div><!-- /mainApp -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JavaScript
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ ì´ˆê¸°í™”: ì¸ì¦ ìƒíƒœ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', async () => {
  try {
    const r = await fetch('/api/status');
    const d = await r.json();

    if (d.authenticated) {
      showApp();
    } else if (!d.password_required) {
      // ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ìš´ì˜ ì¤‘ì´ë©´ ë°”ë¡œ í†µê³¼
      await doLogin(true);
    }
    // else: ë¹„ë°€ë²ˆí˜¸ í™”ë©´ ìœ ì§€
  } catch {
    // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ë¹„ë°€ë²ˆí˜¸ í™”ë©´ ìœ ì§€
  }
});

function showApp() {
  document.getElementById('pwScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('keywordInput').focus();
}

// â”€â”€ ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin(skipInput = false) {
  const pw = skipInput ? '' : document.getElementById('pwInput').value;
  const btn = document.getElementById('pwBtn');
  const errEl = document.getElementById('pwError');

  btn.disabled = true;
  btn.textContent = 'í™•ì¸ ì¤‘...';
  errEl.textContent = '';

  try {
    const r = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw })
    });
    const d = await r.json();

    if (d.success) {
      showApp();
    } else {
      errEl.textContent = d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    }
  } catch {
    errEl.textContent = 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'ì…ì¥í•˜ê¸°';
  }
}

// â”€â”€ ë¡œê·¸ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogout() {
  await fetch('/api/logout', { method: 'POST' });
  location.reload();
}

// â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setEx(text) {
  document.getElementById('keywordInput').value = text;
  document.getElementById('keywordInput').focus();
}

// â”€â”€ CJM ìƒì„± (SSE ìŠ¤íŠ¸ë¦¬ë°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generate() {
  const keyword = document.getElementById('keywordInput').value.trim();
  if (!keyword) { alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

  setLoading(true);
  hideError();
  hideResults();

  try {
    const r = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ keyword })
    });

    if (r.status === 401) { location.reload(); return; }

    const contentType = r.headers.get('content-type') || '';

    // â”€â”€ SSE ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ â”€â”€
    if (contentType.includes('text/event-stream')) {
      const reader = r.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop(); // ë§ˆì§€ë§‰ ë¶ˆì™„ì „ ì¤„ ë³´ì¡´

        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const payload = line.slice(6).trim();
          if (payload === '[DONE]') break;

          let evt;
          try { evt = JSON.parse(payload); } catch { continue; }

          if (evt.type === 'progress') {
            updateLoadingMsg(evt.msg);
          } else if (evt.type === 'result') {
            renderResults(evt.data);
          } else if (evt.type === 'error') {
            showError(evt.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
          }
        }
      }

    // â”€â”€ ì¼ë°˜ JSON ì‘ë‹µ í´ë°± (êµ¬í˜• í™˜ê²½ ëŒ€ë¹„) â”€â”€
    } else if (contentType.includes('application/json')) {
      const d = await r.json();
      if (!r.ok || d.error) { showError(d.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'); return; }
      renderResults(d.data);

    } else {
      const text = await r.text();
      showError(`ì„œë²„ ì˜¤ë¥˜ (${r.status}): ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n\n${text.slice(0, 200)}`);
    }

  } catch (e) {
    if (e.name === 'TypeError' && e.message.includes('fetch')) {
      showError('ğŸ”Œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
    } else {
      showError('ì˜¤ë¥˜: ' + e.message);
    }
  } finally {
    setLoading(false);
  }
}

// â”€â”€ UI ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(on) {
  document.getElementById('loadingSection').classList.toggle('active', on);
  document.getElementById('generateBtn').disabled = on;
  document.getElementById('emptyState').style.display = on ? 'none' : '';
  if (on) updateLoadingMsg('ğŸ¤– ì—ì´ì „íŠ¸ 1: ì¿¼ë¦¬ í™•ì¥ ì¤‘...');
}
function updateLoadingMsg(msg) {
  const el = document.querySelector('.loading-text');
  if (el) el.textContent = msg;
}
function hideError()   { document.getElementById('errorBox').classList.remove('active'); }
function showError(m)  {
  document.getElementById('errorMsg').textContent = m;
  document.getElementById('errorBox').classList.add('active');
  document.getElementById('emptyState').style.display = 'none';
}
function hideResults() {
  document.getElementById('resultsSection').style.display = 'none';
  document.getElementById('cjmContainer').innerHTML = '';
}

// â”€â”€ ê²°ê³¼ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(data) {
  const list = data.cjm_list || [];
  if (!list.length) { showError('CJM ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('resultsSection').style.display = 'block';
  document.getElementById('cjmContainer').innerHTML =
    list.map((cjm, i) => renderCard(cjm, i + 1, list.length)).join('');
}

function renderCard(cjm, idx, total) {
  const { query = '', segment = '', channel = '', action = '', steps = [], table = {} } = cjm;
  return `
<div class="cjm-card">
  <div class="query-section">
    <div>
      <div class="query-label">${total > 1 ? `ì‹œë‚˜ë¦¬ì˜¤ ${idx} / ${total}` : 'í™•ì¥ ì¿¼ë¦¬'}</div>
      <div class="query-chips">
        <span class="query-chip">${esc(segment)}</span>
        <span class="query-arrow">â†’</span>
        <span class="query-chip">${esc(channel)}</span>
        <span class="query-arrow">â†’</span>
        <span class="query-chip">${esc(action)}</span>
      </div>
    </div>
    <div class="query-meta">
      <span class="channel-badge">${esc(channel)}</span><br>
      <span style="font-size:10px;color:#bbb;margin-top:4px;display:block">${steps.length}ë‹¨ê³„ ì—¬ì •</span>
    </div>
  </div>
  <div class="cjm-wrapper">
    <div class="cjm-scroll">${renderTable(steps, table)}</div>
  </div>
</div>`;
}

function renderTable(steps, table) {
  if (!steps.length) return '<p style="padding:20px;color:#aaa">ë‹¨ê³„ ë°ì´í„° ì—†ìŒ</p>';

  const phases = groupPhases(steps);
  const ROWS = [
    { key:'user_action', label:'User Action', cls:'rh-action',  icon:'ğŸ‘£' },
    { key:'feeling',     label:'Feeling',     cls:'rh-feeling', icon:'ğŸ’¬' },
    { key:'painpoint',   label:'Painpoint',   cls:'rh-pain',    icon:'âš¡' },
    { key:'needs',       label:'Needs',       cls:'rh-needs',   icon:'ğŸ’¡' },
    { key:'insight',     label:'Insight',     cls:'rh-insight', icon:'ğŸ¯' },
  ];

  const phaseRow = `<tr class="phase-row">
    <td class="row-header phase-first">PHASE</td>
    ${phases.map(p=>`<td class="phase-cell" colspan="${p.count}">${esc(p.phase)}</td>`).join('')}
  </tr>`;

  const colHead = `<tr>
    <th class="col-header first">êµ¬ë¶„</th>
    ${steps.map(s=>`<th class="col-header">
      <div class="step-num">${s.num}</div>
      <span class="step-name">${esc(s.name)}</span>
    </th>`).join('')}
  </tr>`;

  const dataRows = ROWS.map(row=>`<tr>
    <td class="row-header ${row.cls}">${row.icon}<br>${row.label}</td>
    ${steps.map(s=>{
      const cell = (table[String(s.num)] || table[s.num] || {})[row.key] || {};
      return `<td class="cell">${renderNotes(cell, row.key)}</td>`;
    }).join('')}
  </tr>`).join('');

  return `<table class="cjm-table">
    <thead>${phaseRow}${colHead}</thead>
    <tbody>${dataRows}</tbody>
  </table>`;
}

function renderNotes(field, rowKey) {
  const knowledge = field.knowledge || [];
  const search    = field.search    || [];
  const isQuote   = rowKey === 'feeling';

  const kHtml = knowledge.map(n=>`<span class="note note-data">
    <span class="note-icon icon-data">ğŸ“‹ ë°ì´í„°</span>
    ${isQuote ? `<div class="quote-text">${esc(n.text)}</div>` : esc(n.text)}
    ${n.source ? `<span class="src-tip" data-tip="${esc(n.source_detail || n.source)}">ğŸ“Œ ì¶œì²˜</span>` : ''}
  </span>`).join('');

  const sHtml = search.map(n=>`<span class="note note-search">
    <span class="note-icon icon-search">ğŸ” ì¼ë°˜ì§€ì‹</span>
    ${isQuote ? `<div class="quote-text">${esc(n.text)}</div>` : esc(n.text)}
  </span>`).join('');

  return kHtml + sHtml || '<span style="color:#ddd;font-size:10px">â€”</span>';
}

function groupPhases(steps) {
  const g = [];
  let cur = null;
  steps.forEach(s => {
    if (!cur || cur.phase !== s.phase) { cur = { phase: s.phase || '', count: 1 }; g.push(cur); }
    else cur.count++;
  });
  return g;
}

function esc(s) {
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
